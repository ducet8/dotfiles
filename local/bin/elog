#!/usr/bin/env bash

usage() {
    printf "usage: $0 [-h|d|q|s|t] [emer|alert|crit|error|warn|notice|info|debug] [log_message]\n\n"

    printf "Options:\n"
    printf "\t-h|--help           Print this Help\n"
    printf "\t-d|--debug          Enable Debug\n"
    printf "\t-q|--quiet          Don't print line header\n"
    printf "\t-s|--stacktrace     Enable Stacktrace\n"
    printf "\t-t|--time           Enable Date/Time Stamp\n"

    exit 1
}

set_color_codes() {
    if tput setaf 1 &>/dev/null; then
        reset=$(tput sgr0)
        black=$(tput setaf 0)
        red=$(tput setaf 1)
        green=$(tput setaf 2)
        yellow=$(tput setaf 3)
        blue=$(tput setaf 4)
        cyan=$(tput setaf 6)
        orange=$(tput setaf 166)
        purple=$(tput setaf 125)
        violet=$(tput setaf 61)
        white=$(tput setaf 7)
    else
        reset="\[\e[0m\]"
        black="\[\e[1;30m\]"
        red="\[\e[1;31m\]"
        green="\[\e[1;32m\]"
        yellow="\[\e[1;33m\]"
        blue="\[\e[1;34m\]"
        cyan="\[\e[1;36m\]"
        orange="\[\e[1;33m\]"
        purple="\[\e[1;35m\]"
        violet="\[\e[1;35m\]"
        white="\[\e[1;37m\]"
    fi
}

parse_args() {
    while :; do
        if [[ $# -eq 0 ]]; then
            break
        elif [[ $1 =~ ^- ]]; then
            case $1 in
                -d|--debug)         debug=0                                     ;;
                -h|--help)          usage                                       ;;
                -q|--quiet)         quiet=0                                     ;;
                -s|--stacktrace)    stacktrace=0                                ;;
                -t|--time)          timestamp="$(date '+%Y/%m/%d %H:%M:%S') "   ;;
                *)                  usage                                       ;;
            esac
            shift
        else
            log_type="elog_level_$(echo $1 | awk '{print tolower($0)}')"
            msg=$2
            shift; shift
        fi
    done
}

stacktrace() {
  if [[ "${debug:-}" -ne 0 ]] &&  [[ "${stacktrace:-}" -ne 0 ]]; then
    local BEGIN="${1:-1}" # Display line numbers starting from given index, e.g. to skip "log::stacktrace" and "error" functions.
    local I
    for (( I=BEGIN; I<${#FUNCNAME[@]}; I++ )); do
      echo $'\t\t'"at ${FUNCNAME[$I]}(${BASH_SOURCE[$I]}:${BASH_LINENO[$I-1]})" >&2
    done
    echo
  fi
}

elog_level_emer() {  # Level 0
    printf "${red}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_alert() {  # Level 1
    printf "${orange}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_crit() {  # Level 2
    printf "${violet}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_error() {  # Level 3
    printf "${purple}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_warn() {  # Level 4
    printf "${blue}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_notice() {  # Level 5
    printf "${cyan}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_info() {  # Level 6
    printf "${yellow}${timestamp}${log_header}${msg}${reset}\n"
}

elog_level_debug() {  # Level 7
    printf "${green}${timestamp}${log_header}${msg}${reset}\n"
    stacktrace 2
}

if [ $# -lt 2 ]; then
    usage
fi

parse_args "$@"
elog_levels=($(declare -F | grep elog_ | awk '{print$3}'))
if [[  ! " ${elog_levels[*]} " =~ " ${log_type} " ]]; then
    usage
fi

if [[ -z ${quiet} ]] || [[ ${quiet} -ne 0 ]]; then
    log_header="[$(echo $1 | awk '{print toupper($0)}')]: "
fi

set_color_codes
${log_type} ${msg}
